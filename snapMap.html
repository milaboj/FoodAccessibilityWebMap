<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Interactive Web Mapping</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        h2, h3 {
            margin: 10px;
            font-size: 18px;
        }

        h3 {
            font-size: 16px;
        }

        p {
            margin: 10px;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(0,0,0,0.2);
            margin-left: 20px;
            font-family: Arial;
            overflow: auto;
            border-radius: 3px;
        }

        #features {
            top: 0;
            right: 0;
            left: auto;
            width: 255px;
            max-height: 150px;
            height: auto;
            overflow-y: auto;
            display: none;
        }

        #features.expanded {
            width: 255px;
            max-height: 35%;
        }

        #legend {
            padding: 10px;
            line-height: 18px;
            margin-bottom: 40px;
            width: 150px;
            display: block;
        }

        .legend-key {
            display: inline-block;
            border-radius: 20%;
            width: 14px;
            height: 14px;
            margin-right: 5px;
            border: 1px solid #000;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div class="map-overlay" id="features">
        <h2>Washington State SNAP Percentage by County</h2>
        <div id="text-description">
            <p>Hover over and click on a county!</p>
        </div>
    </div>

    <div class="map-overlay" id="legend"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FyYWg0MTZnIiwiYSI6ImNtZ2d3ejl6eTBwajkycXB1dGJzM2huMGwifQ.vV1HxowcTGJ7rBxRgEY7NQ';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-120, 47],
            zoom: 6
        });

        const featuresPanel = document.getElementById('features');
        let lockedCountyId = null;

        function updateHoverText(feature) {
            const props = feature.properties;
            const snap = props.Updated_HH_SNAP;
            const pop = props["Updated Popualtion_POP_2025"];

            let display = `<h3>${props.County}</h3>`;

            if (!snap || !pop) {
                display += `<p><em>No SNAP data available</em></p>`;
            } else {
                const percent = ((snap / pop) * 100).toFixed(1);
                display += `<p><strong>${percent}%</strong> of population on SNAP</p>`;
            }

            document.getElementById('text-description').innerHTML = display;
        }

        async function geojsonFetch() {
            let response = await fetch("assets/Master_DS.geojson");
            let Master_DS = await response.json();

            map.on("load", () => {
                map.addSource("Master_DS", {
                    type: "geojson",
                    data: Master_DS
                });

                // CHOROPLETH USING % SNAP
                map.addLayer({
                    id: "Master_DS-layer",
                    type: "fill",
                    source: "Master_DS",
                    paint: {
                        "fill-color": [
                            "case",
                            ["||",
                                ["==", ["get", "Updated_HH_SNAP"], null],
                                ["==", ["get", "Updated Popualtion_POP_2025"], null]
                            ],
                            "#d9d9d9",

                            [
                                "step",
                                [
                                    "*",
                                    [
                                        "/",
                                        ["get", "Updated_HH_SNAP"],
                                        ["get", "Updated Popualtion_POP_2025"]
                                    ],
                                    100
                                ],
                                "#f7fbff", 2,
                                "#deebf7", 4,
                                "#c6dbef", 6,
                                "#9ecae1", 8,
                                "#6baed6", 10,
                                "#4292c6", 12,
                                "#2171b5"
                            ]
                        ],
                        "fill-outline-color": "#BBB",
                        "fill-opacity": 0.9
                    }
                });

                // LEGEND  
                const breaks = [
                    "0–2%",
                    "2–4%",
                    "4–6%",
                    "6–8%",
                    "8–10%",
                    "10–12%",
                    "> 12%",
                    "No data"
                ];

                const colors = [
                    "#f7fbff",
                    "#deebf7",
                    "#c6dbef",
                    "#9ecae1",
                    "#6baed6",
                    "#4292c6",
                    "#2171b5",
                    "#d9d9d9"
                ];

                const legend = document.getElementById("legend");
                const title = document.createElement("h4");
                title.textContent = "% of Population on SNAP";
                legend.appendChild(title);

                breaks.forEach((label, i) => {
                    const item = document.createElement("div");
                    const key = document.createElement("span");

                    key.className = "legend-key";
                    key.style.backgroundColor = colors[i];

                    const value = document.createElement("span");
                    value.innerHTML = label;

                    item.appendChild(key);
                    item.appendChild(value);
                    legend.appendChild(item);
                });

                featuresPanel.style.display = "block";

                // Hover
                map.on("mousemove", ({ point }) => {
                    if (featuresPanel.classList.contains("expanded")) return;
                    if (lockedCountyId !== null) return;

                    const county = map.queryRenderedFeatures(point, {
                        layers: ["Master_DS-layer"]
                    });

                    if (county.length) updateHoverText(county[0]);
                });

                // Click for expanded info
                map.on("click", ({ point }) => {
                    const county = map.queryRenderedFeatures(point, {
                        layers: ["Master_DS-layer"]
                    });

                    if (!county.length) {
                        lockedCountyId = null;
                        featuresPanel.classList.remove("expanded");
                        document.getElementById('text-description').innerHTML =
                            `<p>Hover over and click on a county!</p>`;
                        return;
                    }

                    const props = county[0].properties;
                    const snap = props.Updated_HH_SNAP;
                    const pop = props["Updated Popualtion_POP_2025"];

                    lockedCountyId = props.County;

                    let percent = (!snap || !pop) ? null : ((snap / pop) * 100).toFixed(1);
                    let snapText = percent ? `${percent}% on SNAP` : "No SNAP data";

                    let content = `
                        <h3>${props.County}</h3>
                        <p><strong>${snapText}</strong></p>
                    `;

                    document.getElementById("text-description").innerHTML = content;
                    featuresPanel.classList.add("expanded");
                });
            });
        }

        geojsonFetch();
    </script>
</body>
</html>
